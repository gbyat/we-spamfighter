name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          tools: composer

      - name: Validate Plugin Header
        run: |
          php -r "
          \$header = file_get_contents('we-spamfighter.php');
          if (!preg_match('/Version:\s*[\d.]+/', \$header)) {
            echo 'ERROR: Version not found in plugin header\n';
            exit(1);
          }
          echo '✓ Plugin header valid\n';
          "

      - name: Validate CHANGELOG Format
        continue-on-error: true
        run: |
          if [ -f CHANGELOG.md ]; then
            if ! grep -q "^# Changelog" CHANGELOG.md; then
              echo "WARNING: CHANGELOG.md doesn't start with proper header"
              exit 0
            fi
            echo "✓ CHANGELOG.md format valid"
          else
            echo "ℹ️  CHANGELOG.md not found (optional)"
          fi

      - name: Check PHP Syntax
        run: |
          find includes/ -name "*.php" -type f | while read file; do
            php -l "$file" || exit 1
          done
          echo "✓ PHP syntax valid"

      - name: Run PHP Linter (phpcs) - Optional
        continue-on-error: true
        run: |
          # Only run if phpcs is available
          if command -v phpcs &> /dev/null || [ -f vendor/bin/phpcs ]; then
            if [ -f vendor/bin/phpcs ]; then
              vendor/bin/phpcs --standard=WordPress --extensions=php includes/ || true
            else
              phpcs --standard=WordPress --extensions=php includes/ || true
            fi
          else
            echo "ℹ️  phpcs not available, skipping (optional check)"
          fi

      - name: Validate Plugin Constants
        run: |
          php -r "
          require 'we-spamfighter.php';
          \$constants = ['WE_SPAMFIGHTER_VERSION', 'WE_SPAMFIGHTER_PLUGIN_FILE', 'WE_SPAMFIGHTER_GITHUB_REPO'];
          foreach (\$constants as \$const) {
            if (!defined(\$const)) {
              echo 'ERROR: Constant ' . \$const . ' not defined\n';
              exit(1);
            }
          }
          echo '✓ All plugin constants defined\n';
          "
