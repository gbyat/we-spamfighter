name: Release

on:
  push:
    tags:
      - "v*" # Trigger on version tags (e.g., v1.0.0)

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          tools: composer

      - name: Install PHP dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist
          fi

      - name: Run PHP Linter (phpcs)
        continue-on-error: true
        run: |
          # Check if phpcs is available (optional check)
          if command -v phpcs &> /dev/null || [ -f vendor/bin/phpcs ]; then
            if [ -f vendor/bin/phpcs ]; then
              vendor/bin/phpcs --standard=WordPress --extensions=php includes/ we-spamfighter.php || true
            else
              phpcs --standard=WordPress --extensions=php includes/ we-spamfighter.php || true
            fi
          else
            echo "‚ö†Ô∏è  phpcs not found, skipping lint check (optional)"
          fi

      - name: Validate Plugin Header
        run: |
          php -r "
          \$header = file_get_contents('we-spamfighter.php');
          if (!preg_match('/Version:\s*[\d.]+/', \$header)) {
            echo 'ERROR: Version not found in plugin header\n';
            exit(1);
          }
          echo '‚úì Plugin header valid\n';
          "

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Validate and Update CHANGELOG
        continue-on-error: true
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md not found"
            exit 1
          fi

          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}

          if ! grep -q "## \[${VERSION}\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è  Version ${VERSION} not found in CHANGELOG.md"
            echo "üìù Attempting to update CHANGELOG.md automatically..."
            
            # Update package.json version to match tag
            node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json')); pkg.version = '${VERSION}'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
            
            # Run sync-version.js to update CHANGELOG
            if node scripts/sync-version.js 2>&1; then
              echo "‚úÖ Updated CHANGELOG.md using sync-version.js"
            else
              echo "‚ö†Ô∏è  sync-version.js failed, creating basic entry..."
              DATE=$(date +%Y-%m-%d)
              # Create basic entry - insert after line 7 (after main heading)
              sed -i "7a\\\n## [${VERSION}] - ${DATE}\n\n- Version update\n" CHANGELOG.md
              # Add release link at the end
              echo "" >> CHANGELOG.md
              echo "[${VERSION}]: https://github.com/gbyat/we-spamfighter/releases/tag/v${VERSION}" >> CHANGELOG.md
              echo "‚úÖ Created basic CHANGELOG entry for ${VERSION}"
            fi
          else
            echo "‚úì CHANGELOG.md already contains version ${VERSION}"
          fi

  build:
    name: Build Release
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Extract release notes from CHANGELOG
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Extract release notes using dedicated script
          node scripts/extract-release-notes.js ${VERSION} release_notes.txt

          # Read the notes file and set as output (using delimiter for multiline)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Node.js dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build minified assets
        run: npm run build:assets

      - name: Create plugin ZIP
        run: |
          PLUGIN_NAME="we-spamfighter"
          ZIP_NAME="${PLUGIN_NAME}.zip"

          # Create a temporary directory for the plugin
          mkdir -p ${PLUGIN_NAME}

          # Copy main plugin file
          cp we-spamfighter.php ${PLUGIN_NAME}/
          echo "‚úÖ Copied we-spamfighter.php"

          # Copy uninstall script
          if [ -f "uninstall.php" ]; then
            cp uninstall.php ${PLUGIN_NAME}/
            echo "‚úÖ Copied uninstall.php"
          fi

          # Copy includes directory (PHP classes)
          if [ -d "includes" ]; then
            cp -r includes ${PLUGIN_NAME}/
            echo "‚úÖ Copied includes/ (PHP classes)"
          else
            echo "ERROR: Includes directory not found!"
            exit 1
          fi

          # Copy assets directory (CSS/JS)
          if [ -d "assets" ]; then
            cp -r assets ${PLUGIN_NAME}/
            echo "‚úÖ Copied assets/ (CSS/JS assets)"
          else
            echo "‚ö†Ô∏è  Assets directory not found (optional)"
          fi

          # Copy languages directory (translations)
          if [ -d "languages" ]; then
            cp -r languages ${PLUGIN_NAME}/
            echo "‚úÖ Copied languages/ (translations)"
          fi

          # Copy documentation files
          for doc in README.md README.txt LICENSE; do
            if [ -f "$doc" ]; then
              cp "$doc" ${PLUGIN_NAME}/
              echo "‚úÖ Copied $doc"
            fi
          done

          # Create ZIP file - always named we-spamfighter.zip
          zip -r ${ZIP_NAME} ${PLUGIN_NAME}/

          # Clean up temporary directory
          rm -rf ${PLUGIN_NAME}

          echo "‚úÖ ZIP file created: ${ZIP_NAME}"
          ls -lh ${ZIP_NAME}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: we-spamfighter.zip
          body: ${{ steps.release_notes.outputs.notes }}
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-zip
          path: we-spamfighter.zip
          retention-days: 90
