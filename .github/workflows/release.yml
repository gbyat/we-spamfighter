name: Release

on:
  push:
    tags:
      - "v*" # Trigger on version tags (e.g., v1.0.0)

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          tools: composer

      - name: Install PHP dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist
          fi

      - name: Run PHP Linter (phpcs)
        continue-on-error: true
        run: |
          # Check if phpcs is available
          if command -v phpcs &> /dev/null || [ -f vendor/bin/phpcs ]; then
            if [ -f vendor/bin/phpcs ]; then
              vendor/bin/phpcs --standard=WordPress --extensions=php includes/
            else
              phpcs --standard=WordPress --extensions=php includes/
            fi
          else
            echo "phpcs not found, skipping lint check"
          fi

      - name: Validate Plugin Header
        run: |
          php -r "
          \$header = file_get_contents('we-spamfighter.php');
          if (!preg_match('/Version:\s*[\d.]+/', \$header)) {
            echo 'ERROR: Version not found in plugin header\n';
            exit(1);
          }
          echo '✓ Plugin header valid\n';
          "

      - name: Validate CHANGELOG
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md not found"
            exit 1
          fi

          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}

          if ! grep -q "## \[${VERSION}\]" CHANGELOG.md; then
            echo "ERROR: Version ${VERSION} not found in CHANGELOG.md"
            exit 1
          fi

          echo "✓ CHANGELOG.md contains version ${VERSION}"

  build:
    name: Build Release
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Create plugin ZIP
        run: |
          PLUGIN_NAME="we-spamfighter"
          ZIP_NAME="${PLUGIN_NAME}.zip"

          # Create a temporary directory for the plugin
          mkdir -p ${PLUGIN_NAME}

          # Copy main plugin file
          cp we-spamfighter.php ${PLUGIN_NAME}/
          echo "✅ Copied we-spamfighter.php"

          # Copy uninstall script
          if [ -f "uninstall.php" ]; then
            cp uninstall.php ${PLUGIN_NAME}/
            echo "✅ Copied uninstall.php"
          fi

          # Copy includes directory (PHP classes)
          if [ -d "includes" ]; then
            cp -r includes ${PLUGIN_NAME}/
            echo "✅ Copied includes/ (PHP classes)"
          else
            echo "ERROR: Includes directory not found!"
            exit 1
          fi

          # Copy assets directory (CSS/JS)
          if [ -d "assets" ]; then
            cp -r assets ${PLUGIN_NAME}/
            echo "✅ Copied assets/ (CSS/JS assets)"
          else
            echo "⚠️  Assets directory not found (optional)"
          fi

          # Copy languages directory (translations)
          if [ -d "languages" ]; then
            cp -r languages ${PLUGIN_NAME}/
            echo "✅ Copied languages/ (translations)"
          fi

          # Copy documentation files
          for doc in README.md LICENSE; do
            if [ -f "$doc" ]; then
              cp "$doc" ${PLUGIN_NAME}/
              echo "✅ Copied $doc"
            fi
          done

          # Create ZIP file - always named we-spamfighter.zip
          zip -r ${ZIP_NAME} ${PLUGIN_NAME}/

          # Clean up temporary directory
          rm -rf ${PLUGIN_NAME}

          echo "✅ ZIP file created: ${ZIP_NAME}"
          ls -lh ${ZIP_NAME}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: we-spamfighter.zip
          generate_release_notes: true
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-zip
          path: we-spamfighter.zip
          retention-days: 90
